<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Winnings</title>
<style>
body{
  margin:0;
  font-family:Arial;
  background:#001f3f;
  color:white;
}
.header{
  padding:20px;
  background:#003366;
  font-size:18px;
  font-weight:bold;
}
.container{
  padding:20px;
}
.win-row{
  background:#0a2540;
  padding:15px;
  margin-bottom:10px;
  border-radius:10px;
  display:flex;
  justify-content:space-between;
}
.claim-btn{
  margin-top:20px;
  width:100%;
  padding:15px;
  border:none;
  border-radius:10px;
  font-size:16px;
  font-weight:bold;
  cursor:pointer;
}
.enabled{
  background:#00c853;
  color:white;
}
.disabled{
  background:gray;
  color:white;
  cursor:not-allowed;
}
</style>
</head>
<body>

<div class="header">
  BALANCE: R<span id="balance">0</span>
</div>

<div class="container">
  <div id="winsList"></div>
  <button id="claimBtn" class="claim-btn disabled">CLAIM ALL</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getDatabase,ref,get,update,push } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBqJTLjxhZBCsvjrTH_cG0fkXlElG6BqTg",
  authDomain: "tose-ccf8f.firebaseapp.com",
  databaseURL: "https://tose-ccf8f-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "tose-ccf8f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let availableWins = [];
let totalBalance = 0;

onAuthStateChanged(auth, async user=>{
  if(!user){window.location.href="index.html";return;}

  const snap = await get(ref(db,"users/"+user.uid+"/winnings"));
  const data = snap.val() || {};

  const list = document.getElementById("winsList");
  list.innerHTML="";
  totalBalance=0;
  availableWins=[];

  for(const id in data){
    const win = data[id];
    if(win.status==="available"){
      totalBalance += win.amount;
      availableWins.push(id);

      const div = document.createElement("div");
      div.className="win-row";
      div.innerHTML=`<span>${win.cup.toUpperCase()}</span><span>R${win.amount}</span>`;
      list.appendChild(div);
    }
  }

  document.getElementById("balance").innerText=totalBalance;

  const btn = document.getElementById("claimBtn");
  if(totalBalance>0){
    btn.classList.remove("disabled");
    btn.classList.add("enabled");
  }
});

document.getElementById("claimBtn").addEventListener("click", async ()=>{
  const user = auth.currentUser;
  if(!user || totalBalance<=0) return;

  const claimRef = push(ref(db,"claims"));

  await update(claimRef,{
    uid:user.uid,
    totalAmount:totalBalance,
    winningsIncluded:availableWins,
    status:"pending",
    requestedAt:Date.now()
  });

  for(const id of availableWins){
    await update(ref(db,"users/"+user.uid+"/winnings/"+id),{
      status:"pending"
    });
  }

  alert("Claim submitted");
  location.reload();
});
</script>

</body>
</html>
